# -*- mode: ruby -*-
# vi: set ft=ruby :

# All Vagrant configuration is done below. The "2" in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don't change it unless you know what
# you're doing.

# Define hypervisor.
# Currently, "virtualbox" or "libvirt" is supported as default.
PROVIDER = "virtualbox"
DIST_VER = "20.04"

# VM params. 2 CPUs and 8GB memory are the minimum requirements.
NOF_CPU = 2
MEMSIZE = 8  # GB
DISK_SIZE = 50  # GB

# You can have several network interfaces.
PRIVATE_IP = ["192.168.33.11"]
PUBLIC_IP = []
FWD_PORT_LIST = [
  {"guest" => 80, "host" => 10080}
]

# Vagrant boxes
# NOTE: Box can be found at https://app.vagrantup.com/boxes/search
VAGRANT_BOXES = {
  virtualbox: [
    {box: "ubuntu/xenial64", dist_ver: "16.04"},
    {box: "ubuntu/bionic64", dist_ver: "18.04"},
    {box: "ubuntu/focal64", dist_ver: "20.04"}
  ],
  libvirt: [  # It might not work
    {box: "generic/ubuntu1804", dist_ver: "18.04"},
    {box: "yk0/ubuntu-xenial", dist_ver: "16.04"}
  ]
}

# Although you can use any of vagrant box, such as 'ubuntu/xenial64',
# it is decided from `VAGRANT_BOXES` with `PROVIDER` and `DIST_VER`.
my_box = nil

if not my_box
  VAGRANT_BOXES[PROVIDER.to_sym].each do |vbox|
    if vbox[:dist_ver] == DIST_VER
      my_box = vbox[:box]
    end
  end
end

# Check if you have already downloaded target box.
box_list = []
`vagrant box list`.each_line {|l|
  box_list << l.split(" ")[0]
}

# If you don't have the box, download it.
if not (box_list.include? my_box)
  puts "There is no box '#{my_box}' for '#{PROVIDER}'"
  puts "Run 'vagrant box add #{my_box}' first"
end

Vagrant.configure("2") do |config|
  config.vm.box = my_box

  # config.vm.box_check_update = false

  PRIVATE_IP.each do |ipaddr|
    config.vm.network "private_network", ip: ipaddr
  end

  PUBLIC_IP.each do |ipaddr|
    config.vm.network "public_network", ip: ipaddr
  end

  FWD_PORT_LIST.each do |fp|
    ["tcp", "udp"].each do |prot|
      config.vm.network "forwarded_port", guest: fp["guest"], host: fp["host"], auto_correct: true, protocol: prot
    end
  end

  if Vagrant.has_plugin?("vagrant-proxyconf")
    config.proxy.http = ENV["http_proxy"]
    config.proxy.https = ENV["https_proxy"]
    if ENV["no_proxy"] != ""
      config.proxy.no_proxy = ENV["no_proxy"] + "," + PRIVATE_IP.join(",")
    end
  end

  if Vagrant.has_plugin?("vagrant-disksize")
    config.disksize.size = "#{DISK_SIZE}GB"
  end

  # TODO(yasufum) This configuration reported in [1] is required to avoid
  # timeout for ssh login to focal64 because of setting up public key in the
  # VM. This issue is only happened on focal, and not for bionic and xenial.
  # Remove this config after the problem is fixed in the focal image.
  # [1] https://bugs.launchpad.net/cloud-images/+bug/1829625
  if my_box == "ubuntu/focal64"
    config.vm.provider 'virtualbox' do |v|
      v.customize ["modifyvm", :id, "--uart1", "0x3F8", "4"]
      v.customize ["modifyvm", :id, "--uartmode1", "file", "./ttyS0.log"]
    end
  end

  config.vm.provider PROVIDER do |vb|
  #   # Display the VirtualBox GUI when booting the machine
  #   vb.gui = true
  #
  #   # Customize the amount of memory on the VM:
    #vb.customize ["modifyhd", "disk id", "--resize", "size in megabytes"]
    vb.cpus = "#{NOF_CPU}"
    vb.memory = "#{MEMSIZE * 1024}"
  end

  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    apt-upgrade -y
    apt-get install -y python3 python3-dev
    apt-get install -y python3-pip bridge-utils
    apt-get install -y git git-review
    useradd -s /bin/bash -d /opt/stack -m stack
    echo "stack ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/stack
  SHELL
end
